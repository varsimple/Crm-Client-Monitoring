<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–õ–∏—á–Ω–∞—è CRM</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #fff;
            color: #000;
            margin: 0;
            padding: 0;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #000;
            color: #fff;
            padding: 1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 0.5rem;
            text-align: left;
        }
        th {
            background-color: #eee;
        }
        .status-–∞–∫—Ç–∏–≤–Ω—ã–π {
            color: green;
            font-weight: bold;
        }
        .status-–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π {
            color: gray;
            font-weight: bold;
        }
        .status-–∂–¥–µ–º-–æ–ø–ª–∞—Ç—É, .status-–∂–¥–µ–º {
            color: orange;
            font-weight: bold;
        }
        .details {
            display: none;
            background-color: #f9f9f9;
        }
        .row-expanded .details {
            display: table-row;
        }
        .edit-btn, .delete-btn {
            cursor: pointer;
            margin-right: 5px;
        }
        #settings, #add-form, #filters, #modal {
            display: none;
            background-color: #f0f0f0;
            padding: 1rem;
        }
        #modal {
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 10;
        }
        #modal form input, #modal form select {
            display: block;
            margin-bottom: 0.5rem;
            width: 100%;
        }
    </style>
</head>
<body>
<header>
    <h1>–õ–∏—á–Ω–∞—è CRM</h1>
    <div>
        <button onclick="toggleElement('settings')">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button onclick="toggleElement('filters')">üîç –§–∏–ª—å—Ç—Ä</button>
        <button onclick="toggleElement('add-form')">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
</header>

<div id="settings">...</div>
<div id="filters">...</div>
<div id="add-form">...</div>

<table id="clients">
    <thead>
    <tr id="columns">
        <th>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</th>
        <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–ó–∞–º–µ—Ç–∫–∏</th>
        <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ</th>
        <th>‚úè / ‚ùå / ‚Ñπ</th>
    </tr>
    </thead>
    <tbody id="client-body"></tbody>
</table>

<div id="modal"></div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
    // Firebase config & init
    const firebaseConfig = { ... };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const clientsRef = db.collection("clients");
    let clients = [];

    function renderTable(data = clients) {
        const tbody = document.getElementById("client-body");
        tbody.innerHTML = "";

        data.forEach((c, i) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
          <td><a href="${c.url}" target="_blank">${c.name}</a></td>
          <td>${c.contactName}<br>${c.phone}<br>${c.email}</td>
          <td class="status-${normalizeClass(c.status)}">${c.status}</td>
          <td>${c.note}</td>
          <td>${c.lastDate} (${c.lastType})</td>
          <td>
            <span class="edit-btn" onclick="openModal(${i})">‚úè</span>
            <span class="delete-btn" onclick="deleteClient(${i})">‚ùå</span>
            <span class="info-btn" onclick="alert('–ò–ù–ù: ${c.inn || ''}\n–ö–ü–ü: ${c.kpp || ''}\n–ì–æ—Ä–æ–¥: ${c.city || ''}\n–û–ö–í–≠–î: ${c.okved || ''}')">‚Ñπ</span>
          </td>`;
            tbody.appendChild(tr);
        });
    }

    function openModal(index) {
        const c = clients[index];
        const modal = document.getElementById("modal");
        modal.innerHTML = `<h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
        <form onsubmit="submitEdit(event, '${c.id}')">
          <input name="name" value="${c.name}" required />
          <input name="url" value="${c.url}" required />
          <input name="contactName" value="${c.contactName}" />
          <input name="phone" value="${c.phone}" />
          <input name="email" value="${c.email}" />
          <select name="status">
            <option value="–∞–∫—Ç–∏–≤–Ω—ã–π" ${c.status==='–∞–∫—Ç–∏–≤–Ω—ã–π'?'selected':''}>–ê–∫—Ç–∏–≤–Ω—ã–π</option>
            <option value="–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π" ${c.status==='–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π'?'selected':''}>–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π</option>
            <option value="–∂–¥–µ–º" ${c.status==='–∂–¥–µ–º'?'selected':''}>–ñ–¥–µ–º –æ–ø–ª–∞—Ç—É</option>
          </select>
          <input name="note" value="${c.note}" />
          <input name="lastDate" type="date" value="${c.lastDate}" required />
          <select name="lastType">
            <option value="–∑–≤–æ–Ω–æ–∫" ${c.lastType==='–∑–≤–æ–Ω–æ–∫'?'selected':''}>–ó–≤–æ–Ω–æ–∫</option>
            <option value="–ø–æ—á—Ç–∞" ${c.lastType==='–ø–æ—á—Ç–∞'?'selected':''}>–ü–æ—á—Ç–∞</option>
          </select>
          <input name="inn" value="${c.inn}" />
          <input name="kpp" value="${c.kpp}" />
          <input name="city" value="${c.city}" />
          <input name="okved" value="${c.okved}" />
          <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button type="button" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </form>`;
        modal.style.display = 'block';
    }

    function closeModal() {
        document.getElementById("modal").style.display = 'none';
    }

    function submitEdit(e, id) {
        e.preventDefault();
        const form = e.target;
        const data = Object.fromEntries(new FormData(form));
        clientsRef.doc(id).update(data).then(() => {
            closeModal();
            fetchClients();
        });
    }


    function fetchClients() {
        clientsRef.get().then(snapshot => {
            clients = [];
            snapshot.forEach(doc => {
                let data = doc.data();
                data.id = doc.id;
                clients.push(data);
            });
            renderTable();
        });
    }

    document.getElementById("client-form").onsubmit = (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        clientsRef.add(data).then(() => {
            fetchClients();
            e.target.reset();
        });
    };

    function editClient(index) {
        const data = clients[index];
        const fields = ['name', 'url', 'contactName', 'phone', 'email', 'status', 'note', 'lastDate', 'lastType', 'inn', 'kpp', 'city', 'okved'];
        const updates = {};
        for (const key of fields) {
            const val = prompt(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ${key}:`, data[key] || '');
            if (val !== null) updates[key] = val;
        }
        clientsRef.doc(data.id).update(updates).then(fetchClients);
    }

    function deleteClient(index) {
        const data = clients[index];
        if (confirm("–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞?")) {
            clientsRef.doc(data.id).delete().then(fetchClients);
        }
    }

    window.onload = () => {
        fetchClients();
    };
</script>
</body>
</html>
