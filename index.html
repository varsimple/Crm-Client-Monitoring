<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–õ–∏—á–Ω–∞—è CRM</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #fff;
            color: #000;
            margin: 0;
            padding: 0;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #000;
            color: #fff;
            padding: 1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 0.5rem;
            text-align: left;
        }
        th {
            background-color: #eee;
            cursor: move;
        }
        .status-–∞–∫—Ç–∏–≤–Ω—ã–π {
            color: green;
            font-weight: bold;
        }
        .status-–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π {
            color: gray;
            font-weight: bold;
        }
        .status-–∂–¥–µ–º {
            color: orange;
            font-weight: bold;
        }
        .details {
            display: none;
            background-color: #f9f9f9;
        }
        .row-expanded .details {
            display: table-row;
        }
        .edit-btn {
            cursor: pointer;
        }
        #settings, #add-form, #filters {
            display: none;
            background-color: #f0f0f0;
            padding: 1rem;
        }
    </style>
</head>
<body>
<header>
    <h1>–õ–∏—á–Ω–∞—è CRM</h1>
    <div>
        <button onclick="toggleElement('settings')">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button onclick="toggleElement('filters')">üîç –§–∏–ª—å—Ç—Ä</button>
        <button onclick="toggleElement('add-form')">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
</header>

<div id="settings">
    <label>
        –ü–æ–¥–Ω–∏–º–∞—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑:
        <input type="number" id="daysInactive" value="30" /> –¥–Ω–µ–π
    </label>
    <label>
        <input type="checkbox" id="autoSort" checked /> –ê–≤—Ç–æ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö
    </label>
</div>

<div id="filters">
    <h3>–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è</h3>
    <label>–î–∞—Ç–∞ —Å: <input type="date" id="filterDateFrom" /></label>
    <label>–î–∞—Ç–∞ –ø–æ: <input type="date" id="filterDateTo" /></label>
    <label>–ì–æ—Ä–æ–¥: <input type="text" id="filterCity" /></label>
    <label>–û–ö–í–≠–î: <input type="text" id="filterOkved" /></label>
    <label>–°—Ç–∞—Ç—É—Å:
        <select id="filterStatus">
            <option value="">–í—Å–µ</option>
            <option value="–∞–∫—Ç–∏–≤–Ω—ã–π">–ê–∫—Ç–∏–≤–Ω—ã–π</option>
            <option value="–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π</option>
            <option value="–∂–¥–µ–º">–ñ–¥–µ–º –æ–ø–ª–∞—Ç—É</option>
        </select>
    </label>
    <button onclick="applyFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
</div>

<div id="add-form">
    <h3>–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</h3>
    <form id="client-form">
        <input name="name" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" required />
        <input name="url" placeholder="–°–∞–π—Ç" required />
        <input name="contactName" placeholder="–ò–º—è" required />
        <input name="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required />
        <input name="email" placeholder="–ü–æ—á—Ç–∞" required />
        <select name="status">
            <option value="–∞–∫—Ç–∏–≤–Ω—ã–π">–ê–∫—Ç–∏–≤–Ω—ã–π</option>
            <option value="–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π</option>
            <option value="–∂–¥–µ–º">–ñ–¥–µ–º –æ–ø–ª–∞—Ç—É</option>
        </select>
        <input name="note" placeholder="–ó–∞–º–µ—Ç–∫–∞" />
        <input name="lastDate" type="date" required />
        <select name="lastType">
            <option value="–∑–≤–æ–Ω–æ–∫">–ó–≤–æ–Ω–æ–∫</option>
            <option value="–ø–æ—á—Ç–∞">–ü–æ—á—Ç–∞</option>
        </select>
        <input name="inn" placeholder="–ò–ù–ù" />
        <input name="kpp" placeholder="–ö–ü–ü" />
        <input name="city" placeholder="–ì–æ—Ä–æ–¥" />
        <input name="okved" placeholder="–û–ö–í–≠–î" />
        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
    </form>
</div>

<table id="clients">
    <thead>
    <tr id="columns">
        <th>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç</th>
        <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–ó–∞–º–µ—Ç–∫–∏</th>
        <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ</th>
        <th>‚úè</th>
    </tr>
    </thead>
    <tbody id="client-body"></tbody>
</table>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBHhhZ7q1_o7en1YY0HbgqX9533IeFfj14",
        authDomain: "crm-client-monitor.firebaseapp.com",
        projectId: "crm-client-monitor"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const clientsRef = db.collection("clients");

    let clients = [];
    let columnOrder = JSON.parse(localStorage.getItem("columnOrder") || "[]");

    function toggleElement(id) {
        const el = document.getElementById(id);
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    function applyFilters() {
        const from = document.getElementById("filterDateFrom").value;
        const to = document.getElementById("filterDateTo").value;
        const city = document.getElementById("filterCity").value.toLowerCase();
        const okved = document.getElementById("filterOkved").value.toLowerCase();
        const status = document.getElementById("filterStatus").value;

        renderTable(clients.filter(c => {
            if (from && new Date(c.lastDate) < new Date(from)) return false;
            if (to && new Date(c.lastDate) > new Date(to)) return false;
            if (city && (!c.city || !c.city.toLowerCase().includes(city))) return false;
            if (okved && (!c.okved || !c.okved.toLowerCase().includes(okved))) return false;
            if (status && c.status !== status) return false;
            return true;
        }));
    }

    function renderTable(data = clients) {
        const tbody = document.getElementById("client-body");
        tbody.innerHTML = "";

        const autoSort = document.getElementById('autoSort').checked;
        const days = parseInt(document.getElementById('daysInactive').value);
        const now = new Date();

        if (autoSort) {
            data.sort((a, b) => {
                const dateA = new Date(a.lastDate);
                const dateB = new Date(b.lastDate);
                const diffA = (now - dateA) / (1000 * 60 * 60 * 24);
                const diffB = (now - dateB) / (1000 * 60 * 60 * 24);
                if (a.status === '–∞–∫—Ç–∏–≤–Ω—ã–π' && diffA > days) return -1;
                if (b.status === '–∞–∫—Ç–∏–≤–Ω—ã–π' && diffB > days) return 1;
                return 0;
            });
        }

        data.forEach((c, i) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
          <td><a href="${c.url}" target="_blank">${c.name}</a></td>
          <td>${c.contactName}<br>${c.phone}<br>${c.email}</td>
          <td class="status-${c.status}">${c.status}</td>
          <td>${c.note}</td>
          <td>${c.lastDate} (${c.lastType})</td>
          <td><span class="edit-btn" onclick="editClient(${i})">‚úè</span></td>
        `;
            tr.onclick = () => tr.classList.toggle('row-expanded');

            const detail = document.createElement("tr");
            detail.classList.add('details');
            detail.innerHTML = `<td colspan="6">–ò–ù–ù: ${c.inn || ''} | –ö–ü–ü: ${c.kpp || ''} | –ì–æ—Ä–æ–¥: ${c.city || ''} | –û–ö–í–≠–î: ${c.okved || ''}</td>`;

            tbody.appendChild(tr);
            tbody.appendChild(detail);
        });
    }

    function fetchClients() {
        clientsRef.get().then(snapshot => {
            clients = [];
            snapshot.forEach(doc => {
                let data = doc.data();
                data.id = doc.id;
                clients.push(data);
            });
            renderTable();
        });
    }

    document.getElementById("client-form").onsubmit = (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        clientsRef.add(data).then(() => {
            fetchClients();
            e.target.reset();
        });
    };

    function editClient(index) {
        const data = clients[index];
        if (confirm("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å?")) {
            const note = prompt("–ó–∞–º–µ—Ç–∫–∞:", data.note);
            if (note !== null) {
                clientsRef.doc(data.id).update({ note }).then(fetchClients);
            }
        }
    }

    let draggingCol;
    document.querySelectorAll("th").forEach(th => {
        th.draggable = true;
        th.ondragstart = e => draggingCol = th;
        th.ondragover = e => e.preventDefault();
        th.ondrop = e => {
            e.preventDefault();
            if (draggingCol !== th) {
                const row = th.parentNode;
                row.insertBefore(draggingCol, th);
                saveColumnOrder();
            }
        }
    });

    function saveColumnOrder() {
        const headers = Array.from(document.querySelectorAll("#columns th"));
        columnOrder = headers.map(h => h.textContent.trim());
        localStorage.setItem("columnOrder", JSON.stringify(columnOrder));
    }
//h
    window.onload = () => {
        fetchClients();
        if (columnOrder.length) {
            const row = document.getElementById("columns");
            const cols = Array.from(row.children);
            columnOrder.forEach(title => {
                const col = cols.find(th => th.textContent.trim() === title);
                if (col) row.appendChild(col);
            });
        }
    };
</script>
</body>
</html>


